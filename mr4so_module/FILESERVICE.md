# Integrated File Service

The integrated file service provides RESTful endpoints for **upload**, **download** and **deletion** of files. It allows
to identify files by a unique identifier, which is generated by the service.

By default, the file service is enabled and all related endpoints are registered under the base path `/file`. You can
customize this base path, though it is
not recommended, since it destroys compatibility with the GraphQL Frontend. See
the [Configuration Section](#configuration) for more information.

For better readability, we use `/file` as fixed base
path in the following descriptions.

The file service internally uses the [express-fileupload](https://www.npmjs.com/package/express-fileupload) middleware
to handle file uploads.

### File Identifier

Each file is stored with a unique identifier with the format: <br/>`{uuidv4}.{file_extension}`

The file extension is determined by the original file name of the uploaded file or set to `.file`, if the original
extension is unavailable.

The file identifier equals to the file name of the locally stored file.

### File Storage

By default, uploaded files are stored in the `./uploads` directory (or at `/upload` when the backend is running with
Docker). This path can be customized in the configuration. Please make sure that the directory is writable by the
backend service and, if running via Docker, mapped to a writable directory on the host system.

During the upload processes, temporary files are created in a `./temp` subdirectory. These files are deleted after the
upload.

## File Upload

Use one of these endpoints to upload a file:

- `POST /file/upload` (multipart/form-data)
- `PUT /file/upload` (multipart/form-data)
- `PUT /file/upload/{:identifier}` (multipart/form-data)

Note: If the file identifier is provided in the URL `:identifier` path parameter, the file will be uploaded with this
identifier. The identifier **must** be in the format described above. If the identifier is already in use, the file will
be overwritten.

If the `:identifier` is not set, a new identifier will be generated and `POST` and `PUT` requests will behave equally.

### Request

- The file is sent as a `multipart/form-data` request.
- The file is sent in a form field with the name `content_file`. This field name can be customized in the configuration.
- If an original file name is provided in the request, the file extension in the file identifier will be derived from
  this name. Otherwise, the file extension will default to ".file".

### Response

#### Status

- `201 Created` if the file was successfully uploaded.
- `200 OK` if the file was successfully uploaded and an already existing file was overwritten.
- `400 Bad Request` if the request is invalid.
- `413 Payload Too Large` if the file size exceeds the maximum allowed size.

#### Body

The response contains the generated or pre-defined file identifier as a JSON-stringified string, e.g.:

```json
"123e4567-e89b-12d3-a456-426614174000.jpg"
```

Note: Your application should store this identifier to reference the file from a node in the database.
See [GraphQL Schema Integration](#graphql-schema-integration) for more information.

## File Deletion

### Endpoints

- `DELETE /file/{:identifier}`

### Request

- The file identifier must be provided in the URL path parameter `:identifier`.
- The file will be deleted from the file system.
- The file identifier must be in the format described above.

### Response

#### Status

- `204 No Content` if the file was successfully deleted.
- `404 Not Found` if no file was not found with this identifier.
- `400 Bad Request` if the identifier is missing or has an invalid format.

#### Body

No body is returned in the response.

## File Download

To download a file, **the client must know the exact file identifier**. Listing files or searching for files by name is
not possible in order to enable authorization. This is also why all file identifiers must be stored in the database.

Normally you should include the `/file` path in the restricted paths of your application to prevent unauthorized access.
This is also the default behaviour if not manually overridden by implementing
the [`getProtectedEndpoints()` callback method](README.md#restricted-endpoints).

There are two ways to download a file:

1. **With Authentication Header**: The client sends a GET request with an authentication header.
2. **Without Authentication Header**: The client sends a GET request with a temporary JWT token appended as a URL path
   parameter.

### Download With Authentication Header

Use the endpoint:

- `GET /file/{:identifier}`

The file identifier must be provided in the URL path parameter `:identifier`. If file service access is protected, a
valid Bearer token must be provided in the `Authorization` header.

#### Response

##### Status

- `200 OK` if the file was successfully found and can be downloaded.
- `404 Not Found` if no file was found with this identifier.
- `400 Bad Request` if the identifier is missing or has an invalid format.
- `401 Unauthorized` if the provided Bearer token is invalid or missing.

##### Body

On success, the response body contains the file content.

The `content-type` header is set according to the file type.

### Download Without Authentication Header

In some situations, especially when redirecting the user to the download URL in a web application, it is not possible to
provide an authentication header in the GET request. In this case, the file can be downloaded by using a temporary
signed JWT token appended as a URL path parameter. The token is generated by the backend service and is only valid for a
short period of time.

The GraphQL Frontend only uses this method to provide file downloads

#### Step 1: Acquire temporary JWT token

Use the endpoint:

- `GET /file/get_token/{:identifier}`

The file identifier must be provided in the URL path parameter `:identifier`. If file service access is protected, a
valid Bearer token must be provided in the `Authorization` header.

#### Response

##### Status

- `200 OK` if the token was successfully generated.
- `404 Not Found` if no file was found with this identifier.
- `400 Bad Request` if the identifier is missing or has an invalid format.
- `401 Unauthorized` if the provided Bearer token is invalid or missing.

##### Body

On success, the response body contains the generated JWT token wrapped in the `download_token` field of a JSON object:

```json
{
  "download_token": "eyJhbGciOiJIUzI1NiIs..."
}
```

The token has a limited lifetime and is only valid for a short period of time (by default 10 seconds). Hence the
application should proceed with step 2 immediately after receiving the token.

#### Step 2: Use the token to download the file

Use the endpoint:

- `GET /file/by_token/{:token}`

The file identifier must be provided in the URL path parameter `:identifier` and the token in the URL path
parameter `:token`.

Note: This endpoint will **always** be accessible without authentication header.

#### Response

##### Status

- `200 OK` if the file was successfully found and can be downloaded.
- `400 Bad Request` if the token is missing or includes an invalid or missing file name.
- `404 Not Found` if the requested file does no longer exist.
- `401 Unauthorized` if the token is invalid or expired.

##### Body

On success, the response body contains the file content.

The `content-type` header is set according to the file type.

### Client-side File Name

If you want to provide a custom file name for the download, you can use the `?filename={name}` query parameter addd to
one of these requests:

- `GET /file/{:filename}`
- `GET /file/get_token/{:filename}`

The
`{name}` should be URL-encoded.

If you specify a filename, the browser will always treat the file as a download.

## GraphQL Schema Integration

The supplied [base schema](neo4j_base_defs.graphql) provides a pre-defined **scalar type** `FileReference`.

Properties, which contain file identifiers generated by the file service, should be defined with this type. This is the
suggested way to create relations between Neo4j nodes and uploaded files. On the XR application side, your application is responsible to
update the nodes with the file identifiers of your uploaded files.

The **GraphQL Frontend** on the other hand recognizes this field type and provides the appropriate UI for file handling and takes care of sending the corresponding requests to the `/file/...` endpoints.

Currently the UI only supports **one** file per property (i.e. `[FileReference]` is not yet supported).

### Custom Client-side File Name

If you want to store the original (or any custom) file name in the database related to an uploaded file, you should
define
an additional property of type `String` in your schema. The property name must be the original FileReference property
name with the suffix `...FileName`.

```graphql
type MyNodeType {
    id: ID!
    image: FileReference!
    imageFileName: String
}
```

The **GraphQL Frontend** will not display this field as a regular String field, but instead use this property's value to display and update the client side file name in the related file upload field. It will also attach
the `filename` query parameter to the download link provided to the user. This way the backend server will appropriately
set the `content-disposition` header so
that the web browser will use this name as the download file name. 

## Configuration

There are some global configuration variables specific for the file service. See
the [Configuration Section of the README](README.md#configuration)  for more information on how to set and modify these
values.

| Variable Name                   | Description                                                                                                          | Default Value                     |
|---------------------------------|----------------------------------------------------------------------------------------------------------------------|-----------------------------------|
| DH_FILES_ENABLE                 | Enables the file service. If set to false, no file service endpoints will be available.                              | `true`                            |
| DH_FILES_BASE_PATH*             | The base path for the file service.                                                                                  | `/file`                           |
| DH_FILES_UPLOADS_PATH           | The path where uploaded files are stored.                                                                            | `./uploads`  (Docker: `/uploads`) |
| DH_FILES_FORM_FIELD_ID*         | The form field name in the *multipart/form-data* POST/PUT request for the file upload.                               | `content_file`                    |
| DH_FILES_JWT_SECRET             | The secret used to sign the temporary JWT token for file download via token.                                         | `my-file-secret`                  |
| DH_FILES_JWT_EXPIRATION_SECONDS | The expiration time in seconds for the temporary JWT token.                                                          | `10`                              |
| DH_FILES_MAX_UPLOAD_SIZE_MB     | The maximum allowed file size in MB for file uploads.<br/>Set to `0` or unset to remove the limit (not recommended). | `50`                              |

&ast; Warning: Using any other than the default values for one of these variables will cause incompatibility with the *
*GraphQL Frontend**!